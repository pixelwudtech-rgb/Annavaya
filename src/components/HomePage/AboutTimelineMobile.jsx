
"use client";

import { useEffect, useRef, useState } from "react";
import gsap from "gsap";
import { ScrollTrigger } from "gsap/ScrollTrigger";
import { MotionPathPlugin } from "gsap/MotionPathPlugin";
import CountUp from '../CountUp'
gsap.registerPlugin(ScrollTrigger, MotionPathPlugin);

/* =========================
   DATA
========================= */
const MOBILE_STEPS = [
  {
    x: 210,
    y: 40,
    value: 425,
    suffix: "+",
    title: "Fresh Keerai Bundles Delivered",
    text: "Every day, freshly harvested keerai is carefully selected from trusted farms.",
  },
  {
    x: 0,
    y: 270,
    value: 766,
    suffix: "+",
    title: "Meals Made Healthier",
    text: "Our keerai supports everyday home cooking with essential nutrients.",
  },
  {
    x: 170,
    y: 440,
    value: 240,
    suffix: "+",
    title: "Trusted Farming Partners",
    text: "We work closely with farmers who follow responsible growing practices.",
  },
  {
    x: 10,
    y: 550,
    value: 5,
    suffix: "",
    title: "Multi-Stage Quality Checks",
    text: "Each batch is reviewed through multiple stages of inspection. Cleanliness, freshness, and handling standards are verified before the produce moves forward.",
  },
];

export default function PremiumProcessTimeline() {
  const mobileWrapRef = useRef(null);
  const mobilePathRef = useRef(null);
  const mobileDotRef = useRef(null);

  const [activeIndex, setActiveIndex] = useState(0);
  const [isMobile, setIsMobile] = useState(false);

  // âœ… ADD THIS REF (IMPORTANT)
  const lastAnimatedIndex = useRef(null);

  /* =========================
     MOBILE DETECTION
  ========================= */
  useEffect(() => {
    const check = () => setIsMobile(window.innerWidth < 768);
    check();
    window.addEventListener("resize", check);
    return () => window.removeEventListener("resize", check);
  }, []);

  /* =========================
     PATH + DOT SCROLL ANIMATION
  ========================= */
  useEffect(() => {
    if (!isMobile) return;

    const wrap = mobileWrapRef.current;
    const path = mobilePathRef.current;
    const dot = mobileDotRef.current;
    if (!wrap || !path || !dot) return;

    const length = path.getTotalLength();

    gsap.set(path, {
      strokeDasharray: length,
      strokeDashoffset: length,
    });

    gsap.set(dot, {
      motionPath: {
        path,
        align: path,
        alignOrigin: [0.5, 0.5],
        start: 0,
        end: 0,
      },
    });

    const tl = gsap.timeline({
      scrollTrigger: {
        trigger: wrap,
        start: "top center+=80",
        end: "+=900",
        scrub: true,
        onUpdate: (self) => {
          const index = Math.round(
            self.progress * (MOBILE_STEPS.length - 1)
          );
          setActiveIndex(index);
        },
      },
    });

    tl.to(path, { strokeDashoffset: 0, ease: "none" }, 0);
    tl.to(
      dot,
      {
        motionPath: {
          path,
          align: path,
          alignOrigin: [0.5, 0.5],
          start: 0,
          end: 1,
        },
        ease: "none",
      },
      0
    );

    return () => {
      tl.scrollTrigger?.kill();
      tl.kill();
    };
  }, [isMobile]);

  /* =========================
     âœ… FIXED COUNT ANIMATION
  ========================= */
  useEffect(() => {
    if (!isMobile) return;

    // ðŸ”’ PREVENT RE-RUN FOR SAME INDEX
    if (lastAnimatedIndex.current === activeIndex) return;
    lastAnimatedIndex.current = activeIndex;

    const step = MOBILE_STEPS[activeIndex];
    if (!step || step.value == null) return;

    const el = document.querySelector(`.count-${activeIndex}`);
    if (!el) return;

    gsap.killTweensOf(el);
    el.innerText = "0";

    gsap.to(el, {
      innerText: step.value,
      duration: 0.8,
      snap: { innerText: 1 },
      ease: "power1.out",
    });
  }, [activeIndex, isMobile]);

  return (
    <section className="relative text-[#00945A] block md:hidden">
      <div className="text-center mb-24 px-6">
        <h2 className="text-3xl font-semibold">From Farm to Kitchen</h2>
        <p className="mt-4 text-[#227826]/70">
          A journey of freshness, care, and trust.
        </p>
      </div>

      {isMobile && (
        <div ref={mobileWrapRef} className="relative mx-auto">
          {/* SVG â€” UNCHANGED */}
          <svg
            viewBox="0 0 575 1300"
            className="absolute left-1/2 top-0 w-full max-w-[320px] h-[700px] -translate-x-1/2"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              ref={mobilePathRef}
              d="M281.728 0.5V27.413C281.728 78.1477 253.41 124.948 204.392 138.032C180.826 144.323 152.548 150.115 120.513 153.456C58.122 159.964 66.4426 207.599 85.8693 244.858C93.3069 259.123 116.206 255.941 130.062 264.115C135.551 267.221 140.635 273.05 144.552 278.653C149.439 285.644 156.977 297.029 164.962 294.032C170.717 291.872 173.338 280.309 168.412 283.987C167.339 284.788 166.139 286.035 165.17 287.186C161.575 292.655 165.732 293.168 168.26 292.74C179.269 289.664 188.201 293.168 191.29 295.304C201.789 303.578 209.101 310.164 213.838 314.848C218.547 319.505 222.807 324.618 227.002 329.742C239.847 345.431 256.542 369.785 264.315 381.609L240.161 351.701C232.677 341.944 223.523 333.333 217.625 328.339C215.1 326.201 211.015 324.901 211.232 328.202C211.906 338.798 215.07 357.398 216.568 365.373C223.758 391.692 239.224 408.526 246.059 413.653C255.496 421.856 274.519 439.288 282.852 446.978C300.153 461.334 319.645 489.276 320.768 498.249C315.432 473.468 311.874 448.688 311.781 437.579C310.766 418.094 308.451 403.591 306.139 393.731C303.792 383.723 300.461 373.822 295.906 364.606C294.722 362.211 293.48 359.987 292.238 357.957C286.876 349.192 280.396 340.707 271.851 335C262.703 328.89 251.873 325.989 246.059 325.212C234.128 324.636 226.813 321.996 223.575 320.157C222.608 319.608 221.087 318.676 220.296 317.894C218.428 316.044 219.47 313.727 220.958 311.56C222.951 308.655 224.96 306.399 226.854 304.667C231.994 299.966 239.017 297.194 245.925 296.3C252.412 295.46 258.475 296.738 261.506 297.867C266.694 299.208 271.467 301.57 275.48 304.127C283.507 309.242 292.899 317.52 302.118 319.887C309.79 321.856 316.984 321.351 319.938 314.002C320.873 311.673 321.128 309.308 321.049 307.694C320.951 305.164 320.317 304.108 319.509 303.864C317.084 303.13 315.233 307.867 315.208 310.401C315.137 317.534 323.487 318.408 329.807 315.099C331.78 314.067 333.627 312.982 335.214 311.983C337.802 310.353 340.433 308.745 343.354 307.836C356.934 303.611 367.114 306.952 370.762 309.403L389.861 320.085C397.297 324.404 403.301 331.594 412.04 339.844C436.233 362.684 465.796 385.146 497.696 394.599C511.678 398.742 525.962 401.141 535.629 402.117C555.177 404.851 566.243 426.898 569.332 437.579C572.843 447.417 563.552 453.691 555.767 456.639C552.757 457.78 549.643 457.634 546.82 456.088C543.432 454.233 540.335 450.914 541.028 447.115C541.148 446.459 541.316 445.827 541.517 445.226C542.631 441.895 545.672 439.209 549.184 439.269C552.707 439.33 554.595 441.917 555.505 445.086C556.96 450.156 556.858 455.635 556.386 460.888C553.74 490.351 510.807 506.478 487.882 511.066C443.618 525.422 425.062 560.058 421.317 575.581C417.048 599.849 428.152 621.297 434.237 628.988C442.775 641.293 457.642 650.635 464.009 653.769C476.367 660.263 485.073 667.298 487.882 670.004C500.914 681.625 518.964 689.088 526.36 691.367C530.578 692.688 534.099 693.807 537.017 694.75C548.495 698.461 537.033 699.44 525.237 696.921C521.118 695.55 514.405 692.338 508.173 689.148C500.212 685.073 492.925 679.839 485.883 674.325C477.893 668.069 470.416 662.77 464.304 658.69C456.048 653.179 446.915 648.719 439.958 641.638C439.718 641.394 439.496 641.164 439.293 640.951C430.575 632.719 427.444 647.103 428.469 659.049C428.517 659.613 428.568 660.134 428.62 660.605C431.316 679.062 442.289 696.779 447.438 703.33C456.65 717.685 475.243 720.42 483.388 719.993C491.889 718.582 484.527 714.013 478.376 707.978C474.715 704.386 471.599 700.55 469.907 698.203C467.408 694.401 465.594 691.123 464.312 688.313C460.11 679.105 469.861 669.877 473.277 679.404C474.513 683.305 475.716 686.692 476.864 689.622C481.543 701.568 491.727 715.308 503.96 719.174C508.097 720.481 510.029 720.732 514.296 719.948C522.648 718.413 532.197 712.145 536.752 708.457C552.705 696.494 552.012 693.503 549.672 693.503C544.729 693.503 538.25 687.521 535.629 684.531C529.562 677.353 522.241 654.196 519.339 643.514C515.467 627.965 507.725 613.823 501.264 604.25C496.651 597.414 490.858 590.633 482.813 588.816C474.403 586.916 468.242 591.116 465.694 594.38C462.507 597.55 460.345 603.493 458.963 609.349C456.98 617.744 458.352 634.207 450.059 631.834C448.145 631.286 446.469 628.733 445.472 626.424C442.551 620.614 448.374 605.204 451.651 598.226C456.369 587.288 462.979 583.984 465.694 583.699C467.493 583.442 469.085 583.205 470.49 582.987C478.756 581.706 472.78 575.973 466.273 570.717C465.075 569.75 464.157 569.234 462.729 568.661C449.762 563.453 441.205 569.817 438.45 573.872C434.799 578.145 430.024 578.145 428.339 610.616C426.991 636.593 427.216 653.769 387.333 654.623C347.45 655.478 259.821 631.124 197.75 655.478C135.679 679.831 120.232 711.96 114.615 725.974C112.581 731.048 112.007 734.968 112.268 737.946C112.814 744.179 120.11 742.283 123.182 736.832C124.198 735.028 124.813 733.024 124.89 730.955C125.211 722.345 124.682 709.363 120.513 708.457C115.794 707.431 115.925 715.72 116.581 719.993C117.798 724.835 117.367 738.45 105.908 754.173C91.5839 773.826 80.6302 786.217 57.8803 808.007C52.9049 811.902 42.5316 821.556 33.5173 834.073C28.3924 841.189 23.6319 848.602 17.7465 855.103C15.4237 857.669 13.0324 860.228 10.9761 862.268L5.6397 868.249C3.29917 870.955 2.99959 866.284 20.5255 825.951C25.581 815.127 38.7254 789.293 50.8587 772.545C55.4462 765.424 67.5981 748.533 79.5068 737.937C85.2176 732.098 98.4931 722.385 105.908 730.247C109.559 734.662 115.794 747.166 111.525 761.863C110.214 769.981 101.976 792.625 79.5068 818.261C72.9533 826.378 56.2513 845.177 41.8711 855.432C39.1561 857.71 31.0859 863.806 20.5255 869.958C14.1926 873.041 5.19079 871.098 10.2935 866.244C10.5462 866.003 10.8113 865.754 11.0891 865.495C12.482 864.197 14.1354 863.202 15.9147 862.526L15.9888 862.497C17.1364 862.061 18.1412 861.709 19.3612 861.847C21.6525 862.107 23.6148 864.205 24.6816 866.25C25.4228 867.67 25.9882 869.571 25.967 871.935C25.9402 874.921 24.5616 877.68 23.2337 880.354C20.4113 886.039 16.8421 894.178 16.3125 899.011C13.1742 911.628 20.0015 934.071 31.3509 927.728C33.9026 926.302 36.6825 923.352 39.6242 918.238C58.8165 885.197 50.0161 978.48 178.09 971.217C306.164 963.954 323.296 977.198 370.762 981.471C418.228 985.743 449.404 1020.35 455.864 1029.32C459.41 1034.25 463.804 1041.24 467.045 1046.54C469.68 1050.84 475.016 1052.48 479.737 1050.69C480.86 1050.26 483.388 1048.55 482.546 1042.57C481.703 1036.59 475.805 1034.45 471.592 1038.3C469.926 1039.82 465.743 1044.52 461.439 1050.03C451.533 1062.71 441.183 1082.03 441.161 1098.12C441.157 1100.78 441.113 1102 441.019 1104.66C440.46 1120.48 443.472 1146.46 445.191 1158.35C446.058 1163.14 446.742 1166.12 447.25 1167.91C447.728 1169.6 448.766 1169.43 449.205 1167.73C449.36 1167.13 449.413 1166.58 449.435 1165.96C449.479 1164.76 449.533 1163.63 449.595 1162.56C450.186 1152.35 454.758 1142.03 455.679 1131.85C455.772 1130.82 455.837 1129.86 455.88 1128.96C456.044 1125.49 456.176 1122.01 456.077 1118.54C455.742 1106.81 450.066 1097.14 446.876 1093.41C445.472 1091.27 443.816 1089.59 442.031 1088.27C431.532 1080.52 415.124 1083.13 405.946 1092.41C404.059 1094.32 402.59 1096.22 401.657 1097.68C399.522 1102.15 397.946 1105.63 396.815 1108.3C394.173 1114.56 403.729 1114.34 407.921 1109C408.294 1108.52 408.604 1108.14 409.061 1107.75C411.921 1105.27 416.822 1103.17 419.071 1102.38C425.362 1100.33 431.241 1097.26 433.395 1095.97C433.466 1095.94 433.536 1095.91 433.605 1095.88C439.116 1093.5 438.114 1101.94 435.982 1107.56C435.179 1109.67 434.131 1111.43 432.941 1113.35C432.65 1113.82 432.374 1114.28 432.115 1114.72C428.258 1121.31 427.074 1129.36 423.547 1136.13C421.729 1139.62 420.033 1142.17 419.071 1143.4C418.153 1144.94 416.601 1146.47 414.806 1147.89C408.522 1152.87 400.394 1154.51 392.669 1156.64C389.45 1157.66 387.129 1158.39 385.49 1158.9C382.781 1159.74 383.161 1157.85 384.524 1155.36C387.895 1148.18 392.482 1141.55 394.355 1139.13C396.044 1136.7 398.641 1134.88 401.393 1133.56C407.809 1130.48 416.003 1128.66 422.084 1132.36C424.998 1134.13 427.932 1135.98 429.527 1138.99C432.623 1144.84 432.574 1155.05 431.99 1160.49C431.541 1171.77 427.496 1187.98 425.53 1194.67C424.407 1202.19 421.879 1207.77 420.756 1209.62C419.632 1211.33 418.415 1205.78 417.947 1202.79C417.273 1199.03 418.602 1188.4 419.351 1183.56C419.576 1177.41 421.879 1168.18 423.003 1164.33C425.025 1159.55 425.53 1150.95 425.53 1147.24C424.933 1135.88 417.199 1145.81 412.473 1156.16C411.489 1158.32 410.662 1160.29 410.083 1161.77C406.263 1169.29 402.874 1181.99 401.657 1187.41C399.859 1192.88 398.661 1203.07 398.287 1207.49C397.613 1212.61 397.257 1219.59 397.163 1222.44C396.264 1232.7 397.163 1233.26 397.725 1232.27C399.164 1230.08 400.059 1227.58 400.926 1225.11C401.277 1224.1 401.67 1223 402.064 1221.91C403.273 1218.56 404.852 1215.35 406.15 1212.04C407.368 1208.92 408.43 1205.52 408.959 1203.64C410.308 1199.88 409.521 1196.09 408.959 1194.67C408.083 1192.12 407.557 1189.93 407.265 1188.11C406.601 1183.97 407.959 1179.75 407.581 1175.57C407.487 1174.54 407.319 1173.65 407.114 1172.92C406.596 1171.05 405.154 1169.65 403.222 1169.57C399.792 1169.43 396.165 1170.37 393.204 1172.11C390.259 1173.84 387.11 1176.42 385.367 1178.01C380.648 1181.77 375.911 1186.69 374.132 1188.69C373.114 1189.89 372.339 1190.9 371.766 1191.73C369.502 1195.03 375.684 1196.35 379.098 1194.27C379.794 1193.85 380.1 1193.6 380.76 1193.12C381.272 1192.75 381.874 1192.3 382.487 1191.82C384.422 1190.33 386.148 1188.58 388.023 1187.01C389.614 1185.68 391.342 1184.48 392.892 1183.51C395.296 1182.01 399.41 1180.73 399.41 1183.56C399.41 1186.98 395.478 1193.82 393.512 1196.81C391.714 1199.88 389.205 1210.34 388.176 1215.18C387.753 1217.11 386.572 1220.03 385.45 1222.54C384.325 1225.06 383.262 1227.55 381.781 1229.88C380.014 1232.65 377.733 1235.15 375.748 1237.77C375.116 1238.6 374.534 1239.4 374.132 1239.96C373.621 1240.85 373.15 1241.66 372.717 1242.4C368.702 1249.18 368.847 1239.49 370.762 1231.84C372.11 1225.69 375.63 1215.32 377.222 1210.91C378.072 1208.4 378.966 1206.35 379.862 1204.68C383.252 1198.39 392.564 1199.53 393.204 1206.65C393.217 1206.79 393.226 1206.93 393.231 1207.06C393.09 1216.27 391.985 1225.75 390.857 1232.97C389.815 1239.65 388.015 1246.44 389.356 1253.07C390.613 1259.27 394.029 1260.4 397.444 1261.32C398.234 1261.53 399.298 1261.37 400.563 1260.93C412.561 1256.7 426.833 1261.06 427.745 1273.75L427.981 1277.03C428.675 1286.69 419.164 1293.83 410.086 1290.48C403.939 1288.2 400.359 1281.8 401.648 1275.37L403.208 1267.59C404.03 1263.49 405.774 1259.17 409.698 1257.72C410.906 1257.28 412.204 1257.1 413.453 1257.48C420.176 1259.52 416.088 1269.52 410.448 1273.71C409.897 1274.12 409.308 1274.55 408.679 1274.99C400.253 1280.97 393.512 1286.53 367.673 1280.55"
              stroke="#00945A"
              strokeWidth="5"
              strokeLinecap="round"
            />
            <circle ref={mobileDotRef} r="7" fill="white" />
          </svg>

          {/* STEPS â€” UNCHANGED */}
          <div className="relative">
            {MOBILE_STEPS.map((step, i) => (
              <MobileStep
                key={i}
                {...step}
                index={i}
                active={activeIndex === i}
              />
            ))}
          </div>

          <div
            className="pointer-events-none"
            style={{ height: `${MOBILE_STEPS.length * 100}px` }}
          />
        </div>
      )}
    </section>
  );
}

/* =========================
   MOBILE STEP
========================= */
function MobileStep({ x, y, value, suffix, title, text, index, active }) {
  return (
    <div
      className={`absolute max-w-[60%] px-5 transition-opacity duration-500 ${
        active ? "opacity-100" : "opacity-30"
      }`}
      style={{ left: x, top: y, transform: "translateY(-50%)" }}
    >
      {value != null && (
        <div className={`text-base font-semibold mb-2 count-${index}`}>

          <CountUp
  from={0}
  to={value}
  separator=","
  direction="up"
  duration={1}
  className="count-up-text"
  startCounting={false}
/>
        </div>
      )}
      <h3 className="text-xs font-semibold">{title}</h3>
      <p className="text-[8px] text-[#227826]/70 mt-1">{text}</p>
    </div>
  );
}
