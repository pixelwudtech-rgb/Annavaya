"use client";

import { useEffect, useRef, useState } from "react";
import gsap from "gsap";
import { ScrollTrigger } from "gsap/ScrollTrigger";
import { MotionPathPlugin } from "gsap/MotionPathPlugin";
import CountUp from '../CountUp'

gsap.registerPlugin(ScrollTrigger, MotionPathPlugin);

/* =========================
   DATA
========================= */
const MOBILE_STEPS = [
  {
    x: 210,
    y: 70,
    value: 425,
    suffix: "",
    title: "Our Promise of Purity",
    text: "We stand by one clear promise: clean, honest, and uncompromised keerai. No shortcuts, no unnecessary processing, only what your family needs.",
  },
  {
    x: 5,
    y: 300,
    value: 7663,
    suffix: "",
    title: "Freshness You Can Rely On",
    text: "From harvest to delivery, freshness is carefully protected. Gentle handling and quick movement ensure your keerai reaches the kitchen in its best condition.",
  },
  {
    x: 170,
    y: 570,
    value: null,
    suffix: "",
    title: "Thank You for Your Trust",
    text: "Your support helps strengthen farming communities and promotes healthier food choices. Together, we continue building a more responsible food system.",
  },
];

export default function PremiumProcessTimeline() {
  const wrapRef = useRef(null);
  const pathRef = useRef(null);
  const dotRef = useRef(null);

  const [activeIndex, setActiveIndex] = useState(0);
  const [isMobile, setIsMobile] = useState(false);

  /* =========================
     MOBILE DETECTION
  ========================= */
  useEffect(() => {
    const check = () => setIsMobile(window.innerWidth < 768);
    check();
    window.addEventListener("resize", check);
    return () => window.removeEventListener("resize", check);
  }, []);

  /* =========================
     PATH + DOT SCROLL REVEAL
     (NOT STICKY, NOT FIXED)
  ========================= */
  useEffect(() => {
    if (!isMobile) return;

    const wrap = wrapRef.current;
    const path = pathRef.current;
    const dot = dotRef.current;

    if (!wrap || !path || !dot) return;

    const length = path.getTotalLength();

    gsap.set(path, {
      strokeDasharray: length,
      strokeDashoffset: length,
    });

    gsap.set(dot, {
      motionPath: {
        path,
        align: path,
        alignOrigin: [0.5, 0.5],
        start: 0,
        end: 0,
      },
    });

    const tl = gsap.timeline({
      scrollTrigger: {
        trigger: wrap,
        start: "top center",
        end: "+=700",
        scrub: true,
      },
    });

    tl.to(path, { strokeDashoffset: 0, ease: "none" }, 0);
    tl.to(
      dot,
      {
        motionPath: {
          path,
          align: path,
          alignOrigin: [0.5, 0.5],
          start: 0,
          end: 1,
        },
        ease: "none",
      },
      0
    );

    return () => {
      tl.scrollTrigger?.kill();
      tl.kill();
    };
  }, [isMobile]);

  /* =========================
     ACTIVE STEP TRACKING
  ========================= */
  useEffect(() => {
    if (!isMobile) return;

    const triggers = [];

    document.querySelectorAll(".mobile-step").forEach((el, i) => {
      triggers.push(
        ScrollTrigger.create({
          trigger: el,
          start: "top center",
          end: "bottom center",
          onEnter: () => setActiveIndex(i),
          onEnterBack: () => setActiveIndex(i),
        })
      );
    });

    return () => triggers.forEach(t => t.kill());
  }, [isMobile]);

  /* =========================
     COUNT ANIMATION
  ========================= */
  useEffect(() => {
    if (!isMobile) return;

    const step = MOBILE_STEPS[activeIndex];
    if (!step?.value) return;

    const el = document.querySelector(`.count-${activeIndex}`);
    if (!el) return;

    gsap.fromTo(
      el,
      { innerText: 0 },
      {
        innerText: step.value,
        duration: 0.8,
        snap: { innerText: 1 },
        ease: "power1.out",
      }
    );
  }, [activeIndex, isMobile]);

  return (
    <section className="relative block md:hidden text-[#00945A]">
      {isMobile && (
        <div ref={wrapRef} className="relative mx-auto">

          {/* SVG (YOUR EXACT SVG, SAME HEIGHT) */}
          <svg
            viewBox="0 0 605 1066"
            className="absolute left-1/2 top-0 w-full max-w-[320px] -translate-x-1/2"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              ref={pathRef}
              d="M154.131 10.8205L144.3 5.59561C135.853 1.78273 127.689 0.464103 120.535 0.50074C105.25 0.579017 87.3757 7.72857 85.6284 22.9136C85.1118 27.4036 85.3699 31.8637 85.8808 35.076C87.903 46.0136 93.6514 57.5779 96.2728 61.9928C100.092 70.1961 105.354 78.2284 107.507 81.2191L112.976 88.7813C113.448 89.4341 113.997 90.0271 114.613 90.5472L117.301 92.8188C118.199 93.5782 119.422 93.83 120.547 93.4876C121.201 93.2885 121.807 92.8951 121.968 92.2305C122.464 90.1888 121.942 86.234 121.55 84.21C120.876 74.6395 113.405 61.9928 109.754 56.8658L102.171 44.4755L92.1736 27.6667C91.7255 26.9133 91.1733 26.2269 90.5334 25.6278L88.2533 23.4934C87.9921 23.249 87.6478 23.1129 87.2901 23.1129C86.5118 23.1129 85.8808 23.7439 85.8808 24.5223V26.8152C85.8808 27.1931 85.9364 27.5669 86.0564 27.9253C88.8934 36.3984 96.2516 47.2768 99.6431 51.7388C105.26 59.6002 112.844 68.9713 115.933 72.6741C123.723 80.6601 120.935 64.5122 116.887 54.1163C116.128 52.167 115.392 50.4462 114.81 49.1753C109.642 33.4524 98.426 24.1098 93.4641 21.4038C87.1728 17.3022 83.1658 23.1129 81.9487 26.5309C76.1068 39.8612 72.2121 48.3208 70.995 50.8843C70.2353 52.3552 69.1022 53.6755 67.8129 54.8276C62.8577 59.2554 55.9455 61.1686 49.3271 60.571C48.8025 60.5236 48.2838 60.4708 47.7782 60.4144C45.0891 60.1145 42.4637 59.4099 39.9401 58.4342C38.1753 57.7518 37.0627 57.2806 36.4934 57.0205C36.2746 56.9206 36.0716 56.7925 35.8801 56.6468C34.6793 55.7335 34.0969 54.2205 34.3754 52.7378L34.8094 50.4269C34.9651 49.598 35.2444 48.7931 35.6992 48.0828C37.7752 44.8404 40.6481 42.2307 43.3597 40.3054C47.2783 37.5232 51.6618 35.417 55.9852 33.3185C59.0297 31.8407 62.0452 30.58 64.2114 29.7409C65.3577 29.2969 66.5461 28.9791 67.7537 28.7494L70.1726 28.2895C71.826 27.9751 73.5269 28.0108 75.1656 28.3943L75.7749 28.5369C76.145 28.6235 76.5056 28.7466 76.8514 28.9044L78.2666 29.5503C78.8234 29.8044 79.2488 30.2795 79.4399 30.861C79.6085 31.3742 79.5848 31.9336 79.3539 32.422C77.1249 37.1367 73.8917 40.7365 70.8568 43.2706C66.8799 46.5914 62.2887 49.343 57.6784 51.7072C52.9568 54.1284 47.1357 56.4777 43.7513 57.7204C43.3766 57.8436 43.0238 57.958 42.6917 58.0641C38.1723 59.5078 40.3624 53.2028 43.9694 50.1207C45.4275 48.8748 46.4497 49.1089 48.1786 48.2785C50.2763 47.271 53.0001 45.5614 55.4264 43.9212C58.1631 42.0711 60.5682 39.7834 63.0835 37.6419C63.872 36.9705 64.6366 36.3687 65.3728 35.8305C70.8976 31.7917 79.1221 33.0762 79.4438 39.9123C79.5862 42.9379 79.111 46.1394 78.5784 48.3208C74.5339 62.6765 69.4035 75.6649 67.3438 80.3647C61.5019 93.6949 62.2883 108.421 63.4117 114.118C64.7599 126.081 76.8932 134.198 82.7913 136.762C87.7597 139.281 92.417 143.604 95.6818 147.21C98.2829 150.084 100.543 153.268 102.432 156.652C103.813 159.125 105.401 162.121 106.762 164.74C108.009 167.141 108.817 170.581 110.265 172.868C112.28 176.053 116.033 176.128 119.01 178.441C122.223 180.938 122.873 185.177 122.674 187.605C121.702 192.04 119.259 191.253 117.709 189.946C117.247 189.557 116.778 189.162 116.399 188.691C115.08 187.051 114.889 183.938 115.109 181.067C115.274 178.92 117.191 177.147 115.652 175.642C105.916 166.12 90.517 164.478 82.5467 153.435C81.955 152.616 81.3763 151.794 80.8136 150.979C75.6204 143.452 69.9852 135.913 67.2826 127.177C64.7929 119.13 64.0105 109.872 63.9885 102.652C63.9736 97.7887 62.0201 90.9296 59.1988 94.8913C54.705 103.436 52.8325 110.13 52.4581 112.409C48.863 124.372 43.0959 135.338 40.6618 139.325C39.1618 142.309 36.363 146.097 33.5132 149.578C28.9626 155.136 23.5359 162.724 16.7884 160.261C13.6427 159.235 12.6691 164.106 12.5755 166.67C12.5755 169.243 12.1823 172.993 11.8893 175.317C11.7902 176.104 11.77 177.027 11.1413 177.509C10.9186 177.68 10.6621 177.734 10.3843 177.696C6.81756 177.211 5.00418 172.403 4.5996 168.826C4.58262 168.676 4.56692 168.527 4.55246 168.381C4.44059 167.249 4.45468 166.024 5.15073 165.123C5.17867 165.087 5.20705 165.052 5.23586 165.018C7.25719 162.625 11.0428 163.615 13.0438 161.205C14.1459 159.878 15.0084 158.1 15.2514 156.392C15.6459 153.62 15.8923 150.613 16.0388 147.963C16.2615 143.933 16.636 139.868 18.093 136.105C18.8155 134.238 19.585 132.578 20.3533 131.124C23.1102 125.906 27.1598 121.396 31.6901 117.614C36.9737 113.203 42.7585 110.191 45.7173 108.991C56.3901 104.291 56.671 108.563 57.5136 113.69C57.9271 116.207 58.6437 132.787 59.2871 149.898C60.0204 169.397 64.7602 188.54 73.2476 206.109C80.3806 220.875 88.1361 236.856 95.968 252.087C121.244 301.24 179.996 344.719 234.928 350.828C328.641 361.249 438.028 324.496 520.879 384.773C533.143 393.318 560.649 421.346 572.557 465.096C577.239 478.056 583.792 503.635 572.557 502.267C561.323 500.9 557.391 481.759 556.829 472.36C556.361 462.39 560.199 439.974 579.298 430.062C591.576 423.69 597.315 433.455 599.649 445.444C602.105 458.056 596.734 470.56 588.915 480.756C586.442 483.981 583.651 486.945 580.669 489.706C569.005 500.51 549.939 519.8 541.101 534.739C536.513 541.859 526.721 561.826 524.249 584.727C523.781 586.721 523.294 595.494 525.092 614.635C525.092 618.195 524.137 627.281 520.317 635.143C516.853 642.833 507.06 654.369 495.601 638.988C491.856 633.861 483.074 618.736 477.907 599.254C477.431 596.622 477.071 592.538 477.442 588.467C478.247 579.617 486.449 573.656 490.051 565.533C490.976 563.448 491.679 561.256 491.95 559.092C492.605 555.247 493.354 546.36 491.107 541.575C490.171 539.011 488.692 533.2 490.265 530.466C492.715 525.62 499.433 528.499 503.076 532.526C504.531 534.135 506.032 536.141 507.397 538.584C509.831 543.141 514.756 555.332 514.98 567.637C515.074 576.467 514.475 598.228 511.329 614.635C510.955 621.328 503.184 648.388 502.903 649.242C502.623 650.097 507.572 645.143 509.644 641.124C511.038 638.421 511.891 635 512.453 633.434C512.453 633.434 514.483 627.575 514.7 622.753C514.8 620.507 514.882 618.692 514.948 617.236C515.01 615.887 513.865 621.433 513.576 622.753C513.014 625.316 511.329 633.006 509.644 637.279C508.664 639.764 507.209 642.827 506.163 644.955C505.894 645.502 507.018 646.932 507.116 647.533C507.397 649.242 508.801 651.378 506.555 654.369C499.906 663.219 491.517 671.331 488.827 682.068C488.365 683.911 488.067 685.806 488.018 687.695C487.662 689.862 490.11 691.154 491.448 689.413C491.645 689.157 491.833 688.873 492.007 688.56C492.165 688.274 492.327 687.991 492.512 687.72C493.724 685.947 495.895 682.306 496.724 679.15C497.583 676.798 498.824 672.973 499.894 668.794C502.307 659.374 500.917 649.606 498.391 640.215C494.799 626.854 489.885 609.846 485.771 599.254C483.363 592.045 477.641 576.914 471.399 565.527C468.992 561.137 466.741 556.573 463.469 552.784C459.513 548.202 451.367 548.658 448.946 554.206C448.859 554.403 448.776 554.608 448.697 554.819C448.322 556.386 447.798 560.117 448.697 562.51C449.633 564.789 451.618 570.03 452.067 572.764C452.535 576.324 453.415 584.471 453.191 588.572C453.071 592.471 452.967 599.371 453.139 605.194C453.3 610.643 453.771 616.092 453.971 621.539C453.999 622.291 454.029 623.045 454.062 623.787C454.332 629.94 454.935 636.526 456.599 642.457C457.756 646.581 460.168 650.012 463.806 652.273C465.168 653.119 466.787 653.879 468.638 654.369C470.831 655.056 474.988 656.256 478.611 657.049C481.481 657.676 485.238 659.57 487.175 657.36C490.821 654.191 480.673 651.301 476.541 648.798C474.44 647.526 472.173 646.202 470.014 645.027C465.161 642.385 460.408 639.654 455.026 638.401C452.319 637.771 449.19 638.507 447.323 640.566C446.802 641.14 446.274 641.823 445.765 642.628C443.212 646.661 442.113 651.442 440.718 656.006C440.03 658.254 439.349 660.768 438.788 663.355C437.149 670.913 436.488 678.798 437.492 686.466C437.668 687.806 437.909 689.187 438.233 690.577C439.412 695.653 439.584 698.896 443.834 701.912C450.248 706.463 461.445 701.099 467.852 696.538C471.989 693.594 476.44 690.147 479.873 686.84C483.222 683.147 489.662 675.401 494.576 667.743C497.709 662.86 503.002 660.607 502.061 666.332C501.608 672.141 499.821 683.272 495.941 693.204C492.623 701.696 487.283 709.291 484.093 717.832C482.353 722.491 480.476 728.036 478.695 734.216C474.423 749.04 475.234 765.453 468.7 779.429C464.665 788.061 457.694 798.072 446.169 808.18C421.453 825.412 341.744 875.515 306.018 931.229C302.46 938.919 289.391 957.547 265.574 970.536C259.681 973.192 245.885 977.241 229.694 976.829C220.058 976.584 210.882 972.671 201.294 971.688C196.69 971.216 191.774 971.434 187.494 973.099C178.036 978.215 181.813 994.436 188.969 986.41C191.264 983.836 194.108 980.454 197.605 976.09C203.597 969.966 232.24 935.932 239.43 890.814C240.701 878.781 237.102 862.777 231.689 850.652C228.473 843.449 223.31 836.973 215.8 834.557C203.552 830.616 183.892 829.541 176.93 843.814C166.93 864.314 172.93 863.814 169.074 878.24C166.885 886.431 169.07 890.019 167.889 887.38C162.193 874.65 159.973 864.337 151.43 853.314C139.664 838.133 117.43 829.314 97.9296 846.814C78.4296 864.314 80.9296 877.314 80.9296 888.314C80.9296 899.314 84.4916 918.046 93.7106 936.68C102.93 955.314 126.563 976.246 145.886 991.969C147.946 993.535 155.436 999.232 159.93 995.814C164.204 992.563 158.654 989.258 153.678 987.236C143.042 982.915 124.199 976.996 115.899 981.542C110.188 984.39 96.5754 992.565 87.8125 1002.48C76.2971 1014.44 50.57 1042.04 39.7849 1056.74M154.131 10.8205L161.591 14.7859C165.397 16.8083 168.075 20.4518 168.871 24.6869L169.278 26.8574C169.653 28.8497 169.287 30.9101 168.251 32.6524L167.763 33.4729C165.908 36.5916 162.031 37.855 158.694 36.4277C156.695 35.5723 155.186 33.8633 154.585 31.7733L153.005 26.2787C152.086 23.0832 152.009 19.7043 152.781 16.4701L154.131 10.8205ZM154.131 10.8205L158.905 1.32303"
              stroke="#00945A"
              strokeWidth="5"
              strokeLinecap="round"
            />
            <circle ref={dotRef} r="6" fill="white" />
          </svg>

          {/* STEPS */}
          <div className="relative">
            {MOBILE_STEPS.map((step, i) => (
              <div key={i} className="mobile-step">
                <MobileStep {...step} index={i} active={activeIndex === i} />
              </div>
            ))}
          </div>

          {/* SCROLL SPACE â€” NOT STICKY */}
          <div style={{ height: "610px" }} />
        </div>
      )}
    </section>
  );
}

/* =========================
   STEP ITEM
========================= */
function MobileStep({ x, y, value, suffix, title, text, index, active }) {
  return (
     <div
      className={`absolute max-w-[60%] px-5 transition-opacity duration-500 ${
        active ? "opacity-100" : "opacity-30"
      }`}
      style={{ left: x, top: y, transform: "translateY(-50%)" }}
    >
      {value != null && (
         <div className={`text-base font-semibold mb-2 count-${index}`}>
        
                  <CountUp
          from={0}
          to={value}
          separator=","
          direction="up"
          duration={1}
          className="count-up-text"
          startCounting={false}
        />
                </div>
      )}
      <h3 className="text-xs font-semibold">{title}</h3>
      <p className="text-[8px] text-[#00945A]/70 mt-1">{text}</p>
    </div>
  );
}
